<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>FrequÃªncia Bolsistas</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background:#f4f4f4;
  margin:0;
  padding:10px;
}
h2 { text-align:center; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:12px;
  background:#fff;
}
th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center;
}
th {
  background:#eaeaea;
}
select, input[type="text"] {
  width:100%;
}
button {
  padding:6px 10px;
  cursor:pointer;
}
.msg {
  text-align:center;
  margin:10px 0;
  font-weight:bold;
}
.sucesso { color:green; }
.erro { color:red; }

@media (max-width: 768px) {
  table { font-size:10px; }
}
</style>
</head>

<body>

<h2>FrequÃªncia de Bolsistas</h2>

<div class="msg" id="msg"></div>

<table id="tabela">
<thead>
<tr>
  <th>MatrÃ­cula</th>
  <th>Nome</th>
  <th>Campus</th>
  <th>Setor</th>

  <th>Jan</th><th>Fev</th><th>Mar</th><th>Abr</th>
  <th>Mai</th><th>Jun</th><th>Jul</th><th>Ago</th>
  <th>Set</th><th>Out</th><th>Nov</th><th>Dez</th>

  <th>Justificativa</th>
  <th>Arquivo</th>
</tr>
</thead>
<tbody></tbody>
</table>

<br>
<button onclick="salvarTudo()">ðŸ’¾ Salvar FrequÃªncia</button>

<script>
const EMAIL_LOGADO = sessionStorage.getItem("coordenadorLogado");
const URL_API = "https://script.google.com/macros/s/AKfycbxZOYdKpvSBCt4sKsV0dMhI4D3yMokvvrR_htQbdK9GZo-5rvSFPJ-ryN7zkhwwx_DJxg/exec";

const meses = ["Jan","Fev","Mar","Abr","Mai","Jun","Jul","Ago","Set","Out","Nov","Dez"];

function mostrarMsg(texto, tipo="sucesso") {
  const msg = document.getElementById("msg");
  msg.className = "msg " + tipo;
  msg.innerText = texto;
  setTimeout(()=>msg.innerText="", 4000);
}

// ================== CARREGAR BOLSISTAS ==================
async function carregar() {
  try {
    const resp = await fetch(`${URL_API}?acao=listar&email=${encodeURIComponent(EMAIL_LOGADO)}`);
    const json = await resp.json();

    const tbody = document.querySelector("#tabela tbody");
    tbody.innerHTML = "";

    json.dados.forEach(linha => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${linha[2]}</td>
        <td>${linha[1]}</td>
        <td>${linha[0]}</td>
        <td>${linha[3]}</td>
      `;

      meses.forEach(() => {
        const td = document.createElement("td");
        td.innerHTML = `
          <select>
            <option value=""></option>
            <option value="SIM">SIM</option>
            <option value="NÃƒO">NÃƒO</option>
          </select>
        `;
        tr.appendChild(td);
      });

      tr.innerHTML += `
        <td><input type="text" placeholder="Opcional"></td>
        <td><input type="file"></td>
      `;

      tbody.appendChild(tr);
    });

  } catch (e) {
    mostrarMsg("Erro ao carregar dados", "erro");
  }
}

// ================== SALVAR ==================
async function salvarTudo() {
  try {
    const linhas = document.querySelectorAll("#tabela tbody tr");
    let dados = [];

    linhas.forEach(tr => {
      const tds = tr.querySelectorAll("td");

      let registro = {
        matricula: tds[0].innerText,
        meses: {},
        justificativa: tds[16].querySelector("input").value,
        arquivo: tds[17].querySelector("input").files[0] || null
      };

      meses.forEach((m, i) => {
        registro.meses[m] = tds[4 + i].querySelector("select").value;
      });

      dados.push(registro);
    });

    const form = new FormData();
    form.append("acao", "salvar");
    form.append("email", EMAIL_LOGADO);
    form.append("dados", JSON.stringify(dados));

    dados.forEach((d,i)=>{
      if(d.arquivo){
        form.append(`arquivo_${i}`, d.arquivo);
      }
    });

    const resp = await fetch(URL_API, {
      method:"POST",
      body: form
    });

    const r = await resp.json();

    if(r.status === "ok"){
      mostrarMsg("Dados salvos com sucesso!");
    } else {
      mostrarMsg("Erro ao salvar", "erro");
    }

  } catch (e) {
    mostrarMsg("Erro de conexÃ£o com o servidor", "erro");
  }
}

// ================== INIT ==================
if(!EMAIL_LOGADO){
  alert("SessÃ£o expirada. FaÃ§a login novamente.");
  location.href = "index.html";
} else {
  carregar();
}
</script>

</body>
</html>
